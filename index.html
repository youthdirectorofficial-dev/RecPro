<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RecPro - All in One</title>
  <style>
    /* --- Global Styles & Default Theme --- */
    :root {
      --bg-grad-1: #0f2027;
      --bg-grad-2: #203a43;
      --bg-grad-3: #2c5364;
      --text-color: white;
      --nav-bg: rgba(0, 0, 0, 0.2);
      --script-box-bg: rgba(255, 255, 255, 0.1);
      --textarea-bg: rgba(0, 0, 0, 0.3);
      --textarea-border: #444;
      --record-btn: #ff4b5c;
      --pause-btn: #ffc93c;
      --stop-btn: #1fab89;
      --dashed-border: white;
    }

    /* --- Forest Theme --- */
    .theme-forest {
      --bg-grad-1: #134e5e;
      --bg-grad-2: #71b280;
      --bg-grad-3: #6a9113;
      --record-btn: #d32f2f;
      --pause-btn: #fbc02d;
      --stop-btn: #388e3c;
    }

    /* --- Sunset Theme --- */
    .theme-sunset {
      --bg-grad-1: #ff7e5f;
      --bg-grad-2: #feb47b;
      --bg-grad-3: #ff5e62;
      --record-btn: #c2185b;
      --pause-btn: #f57c00;
      --stop-btn: #512da8;
      --text-color: #000;
      --nav-bg: rgba(0, 0, 0, 0.1);
      --script-box-bg: rgba(0, 0, 0, 0.05);
      --dashed-border: #000;
    }

    /* --- Midnight Theme --- */
    .theme-midnight {
      --bg-grad-1: #000000;
      --bg-grad-2: #434343;
      --bg-grad-3: #1e1e1e;
      --record-btn: #00bcd4;
      --pause-btn: #ffeb3b;
      --stop-btn: #e91e63;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2), var(--bg-grad-3));
      color: var(--text-color);
      min-height: 100vh;
      transition: background 0.5s ease, color 0.5s ease;
    }

    header {
      background: transparent;
      padding: 10px 20px;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
    }

    header span {
      font-size: 2.5rem;
      margin-right: 10px;
    }

    nav {
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding: 10px 0;
      background-color: var(--nav-bg);
    }

    nav a {
      color: var(--text-color);
      text-decoration: none;
      font-size: 1.2rem;
      cursor: pointer;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 20px;
      text-align: center;
    }

    .page-content {
        display: none; /* Pages are hidden by default */
    }
    .page-content.active {
        display: block; /* The active page is shown */
    }

    canvas#waveformCanvas {
      width: 100%;
      max-width: 800px;
      height: 120px; /* Increased height for better visuals */
      margin: 20px auto;
      background: transparent;
      border-radius: 5px;
    }

    .record-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .record-buttons button {
      border: none;
      padding: 20px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: 0.3s;
      font-size: 1.5rem; /* For better emoji rendering */
    }

    .record { background-color: var(--record-btn); }
    .pause { background-color: var(--pause-btn); }
    .stop { background-color: var(--stop-btn); }

    .record-buttons button:hover {
      transform: scale(1.1);
    }

    #audioPlayback {
        width: 90%;
        max-width: 600px;
        margin-top: 20px;
    }

    .script-box {
      background: var(--script-box-bg);
      padding: 15px;
      border-radius: 10px;
      margin: 20px auto;
      width: 90%;
      max-width: 600px;
      color: var(--text-color);
    }

    textarea {
      width: 100%;
      padding: 10px;
      background-color: var(--textarea-bg);
      color: var(--text-color);
      border: 1px solid var(--textarea-border);
      border-radius: 8px;
      resize: none;
      height: 120px;
    }

    .ads {
      margin: 30px 0;
      padding: 20px;
      border: 2px dashed var(--dashed-border);
      text-align: center;
    }

    /* Library Page Styles */
    #recordingList {
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        margin-top: 20px;
    }
    .recording-item {
        background: var(--script-box-bg);
        padding: 15px 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 700px;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    .recording-item audio {
        flex-grow: 1;
        margin: 10px 15px;
    }
    .recording-item .delete-btn {
        background-color: var(--record-btn);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
    }

    /* Settings Page Styles */
    .theme-selector {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 30px;
    }
    .theme-button {
        padding: 20px 40px;
        border-radius: 10px;
        border: 2px solid var(--text-color);
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: bold;
        transition: transform 0.2s;
        color: white; /* Default color for buttons */
    }
    .theme-button:hover {
        transform: scale(1.05);
    }
    #theme-default { background: linear-gradient(135deg, #0f2027, #2c5364); }
    #theme-forest { background: linear-gradient(135deg, #134e5e, #71b280); }
    #theme-sunset { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: black; border-color: black; }
    #theme-midnight { background: linear-gradient(135deg, #000000, #434343); }
  </style>
</head>
<body>
  <header><span>üî•</span>RecPro</header>
  <nav>
    <a onclick="showPage('home')">Home</a>
    <a onclick="showPage('library')">Library</a>
    <a onclick="showPage('settings')">Settings</a>
  </nav>

  <main id="page-home" class="page-content">
    <h2>Record Your Audio</h2>
    <div class="script-box">
      <h3>Script (Editable)</h3>
      <textarea placeholder="Write or paste your script here..."></textarea>
      <input type="file" accept=".txt,.pdf,.docx" />
    </div>
    <canvas id="waveformCanvas"></canvas>
    <div class="record-buttons">
      <button class="record" onclick="startRecording()" title="Start Recording">üî¥</button>
      <button class="pause" onclick="pauseRecording()" title="Pause/Resume">‚è∏Ô∏è</button>
      <button class="stop" onclick="stopRecording()" title="Stop and Save">‚èπÔ∏è</button>
    </div>
    <audio id="audioPlayback" controls></audio>
    <section class="ads">Ad Placeholder 1</section>
  </main>

  <main id="page-library" class="page-content">
    <h2>My Recordings</h2>
    <div id="recordingList">
        <p>Loading recordings...</p>
    </div>
    <section class="ads">Ad Placeholder 2</section>
  </main>

  <main id="page-settings" class="page-content">
    <h2>Choose a Theme</h2>
    <div class="theme-selector">
      <div class="theme-button" id="theme-default" onclick="setTheme('theme-default')">Default</div>
      <div class="theme-button" id="theme-forest" onclick="setTheme('theme-forest')">Forest</div>
      <div class="theme-button" id="theme-sunset" onclick="setTheme('theme-sunset')">Sunset</div>
      <div class="theme-button" id="theme-midnight" onclick="setTheme('theme-midnight')">Midnight</div>
    </div>
    <section class="ads">Ad Placeholder 3</section>
  </main>

  <script>
    // --- GLOBAL VARIABLES & INITIAL SETUP ---
    let mediaRecorder;
    let audioChunks = [];
    let audioContext;
    let analyser;
    let source;
    let dataArray;
    let drawVisual;
    let db;
    const canvas = document.getElementById('waveformCanvas');
    const canvasCtx = canvas.getContext('2d');
    
    document.addEventListener('DOMContentLoaded', () => {
        // Apply theme on initial load
        const savedTheme = localStorage.getItem('recpro-theme') || 'theme-default';
        applyTheme(savedTheme);
        
        // Setup IndexedDB
        setupDB();

        // Show home page by default
        showPage('home');
        
        // Draw an empty canvas initially
        clearCanvas();
    });

    // --- PAGE NAVIGATION ---
    function showPage(pageId) {
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(`page-${pageId}`).classList.add('active');

        // If navigating to the library, refresh the list
        if (pageId === 'library') {
            loadRecordings();
        }
    }

    // --- THEME MANAGEMENT ---
    function setTheme(themeName) {
        applyTheme(themeName);
        localStorage.setItem('recpro-theme', themeName);
    }
    
    function applyTheme(themeName) {
        document.body.className = ''; // Clear all classes
        if (themeName !== 'theme-default') {
            document.body.classList.add(themeName);
        }
    }

    // --- INDEXEDDB DATABASE MANAGEMENT ---
    function setupDB() {
        const request = indexedDB.open('audioDB', 1);
        request.onupgradeneeded = event => {
            let database = event.target.result;
            database.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
        };
        request.onsuccess = event => { db = event.target.result; };
        request.onerror = event => { console.error('DB error:', event.target.errorCode); };
    }

    function saveRecording(blob) {
        if (!db) return;
        const transaction = db.transaction(['recordings'], 'readwrite');
        const store = transaction.objectStore('recordings');
        const recording = {
            audio: blob,
            date: new Date().toISOString()
        };
        const request = store.add(recording);
        request.onsuccess = () => {
            console.log('Recording saved!');
            alert('Recording saved to your library!');
        }
        request.onerror = (event) => {
            console.error('Error saving recording:', event.target.error);
        }
    }

    function loadRecordings() {
        if (!db) {
            setTimeout(loadRecordings, 100); // Wait for DB to be ready
            return;
        }
        const transaction = db.transaction(['recordings'], 'readonly');
        const store = transaction.objectStore('recordings');
        const getAllRequest = store.getAll();
        const list = document.getElementById('recordingList');
        list.innerHTML = ''; // Clear previous list
        
        getAllRequest.onsuccess = () => {
            const recordings = getAllRequest.result;
            if (recordings.length === 0) {
                list.innerHTML = '<p>No recordings found. Go to the Home page to create one!</p>';
                return;
            }

            recordings.reverse().forEach(rec => {
                const audioUrl = URL.createObjectURL(rec.audio);
                const recordingItem = document.createElement('div');
                recordingItem.className = 'recording-item';
                const formattedDate = new Date(rec.date).toLocaleString();
                recordingItem.innerHTML = `
                    <span>${formattedDate}</span>
                    <audio controls src="${audioUrl}"></audio>
                    <button class="delete-btn" data-id="${rec.id}">Delete</button>
                `;
                list.appendChild(recordingItem);
            });
        };
    }

    document.getElementById('recordingList').addEventListener('click', event => {
        if (event.target.classList.contains('delete-btn')) {
            const recordingId = Number(event.target.getAttribute('data-id'));
            deleteRecording(recordingId);
        }
    });

    function deleteRecording(id) {
        if (confirm('Are you sure you want to delete this recording?')) {
            const transaction = db.transaction(['recordings'], 'readwrite');
            const store = transaction.objectStore('recordings');
            const deleteRequest = store.delete(id);
            deleteRequest.onsuccess = () => {
                console.log('Recording deleted');
                loadRecordings(); // Reload the list
            };
        }
    }

    // --- AUDIO RECORDING & VISUALIZATION ---
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // Setup MediaRecorder
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) audioChunks.push(event.data);
            };
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                document.getElementById('audioPlayback').src = audioUrl;
                saveRecording(audioBlob);
                cancelAnimationFrame(drawVisual);
                clearCanvas();
                stream.getTracks().forEach(track => track.stop()); // Release microphone
            };

            // Setup Web Audio API for visualization
            if (!audioContext || audioContext.state === 'closed') audioContext = new AudioContext();
            source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            analyser.smoothingTimeConstant = 0.85; // Add smoothing
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            source.connect(analyser);
            
            mediaRecorder.start();
            visualize();
        } catch (err) {
            console.error("Error accessing microphone:", err);
            alert("Could not access microphone. Please grant permission.");
        }
    }

    function visualize() {
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;
        const bufferLength = analyser.frequencyBinCount;
        analyser.getByteTimeDomainData(dataArray);

        canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.05)'; // Fainter trail
        canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
        canvasCtx.lineWidth = 2.5; // Thicker line
        canvasCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
        canvasCtx.beginPath();
        
        const sliceWidth = WIDTH * 1.0 / bufferLength;
        let x = 0;

        // Use quadratic curves for a smoother line
        canvasCtx.moveTo(0, HEIGHT / 2);
        for (let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * HEIGHT / 2;

            const x_mid = x + sliceWidth / 2;
            const y_mid = (y + (dataArray[i + 1] / 128.0 * HEIGHT / 2)) / 2;
            
            if (i === 0) {
                canvasCtx.moveTo(x, y);
            } else {
                 canvasCtx.quadraticCurveTo(x, y, x_mid, y_mid);
            }
            x += sliceWidth;
        }

        canvasCtx.lineTo(WIDTH, HEIGHT / 2);
        canvasCtx.stroke();
        drawVisual = requestAnimationFrame(visualize);
    }

    function clearCanvas() {
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function pauseRecording() {
        if (!mediaRecorder) return;
        if (mediaRecorder.state === 'recording') {
            mediaRecorder.pause();
            cancelAnimationFrame(drawVisual);
        } else if (mediaRecorder.state === 'paused') {
            mediaRecorder.resume();
            visualize();
        }
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
    }
  </script>
</body>
</html>
